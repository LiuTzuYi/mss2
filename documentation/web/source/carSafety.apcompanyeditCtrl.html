<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <base href="../">
    <title>JSDoc: source : apcompanyeditCtrl.js</title>
    <link href="css/prettify-tomorrow.css" type="text/css" rel="stylesheet">
    <link href="css/site.css" type="text/css" rel="stylesheet">
    <link href="css/custom.css" type="text/css" rel="stylesheet">
  </head>
  <body ng-app>
    <nav id="toc">
      <div class="sidenav-search">
      <input placeholder="Filter" id="filter-input" class="col12 block field" type="text">
      </div>
      <div class="nav-wrapper">
      <h2><a href="index.html">Home</a></h2>
      <ul class="module">
        <!-- undefined -->
        <li id="undefined" ng-hide="moduleundefined">
          <ul class="group">
            <h2 class="nav-group">
              <a href ng-click="undefinedModule = !undefinedModule">
                Module
              </a>
              <i ng-cloak ng-show="undefinedModule">+</i>
            </h2>
            <ul ng-hide="undefinedModule">
              <li>
                <a href="carSafety.html">carSafety</a>
              </li>
            </ul>
          </ul>
        </li>
      </ul><ul class="module">
        <!-- car_afety -->
        <h2 class="module">
          <a chref ng-click="modulecar_afety = !modulecar_afety">
            module: carSafety
          </a>
          <i ng-cloak ng-show="modulecar_afety">+</i>
        </h2>
        <li id="carSafety" ng-hide="modulecar_afety">
          <ul class="group">
            <h2 class="nav-group">
              <a href ng-click="car_afetyController = !car_afetyController">
                Controller
              </a>
              <i ng-cloak ng-show="car_afetyController">+</i>
            </h2>
            <ul ng-hide="car_afetyController">
              <li>
                <a href="carSafety.adminpanelloginCtrl.html">adminpanelloginCtrl</a>
              </li><li>
                <a href="carSafety.adminpanelnavCtrl.html">adminpanelnavCtrl</a>
              </li><li>
                <a href="carSafety.apcompanyaddCtrl.html">apcompanyaddCtrl</a>
              </li><li>
                <a href="carSafety.apcompanyeditCtrl.html">apcompanyeditCtrl</a>
              </li><li>
                <a href="carSafety.apcompanylistCtrl.html">apcompanylistCtrl</a>
              </li><li>
                <a href="carSafety.apdeviceaddCtrl.html">apdeviceaddCtrl</a>
              </li><li>
                <a href="carSafety.apdeviceeditCtrl.html">apdeviceeditCtrl</a>
              </li><li>
                <a href="carSafety.apdevicelistCtrl.html">apdevicelistCtrl</a>
              </li><li>
                <a href="carSafety.apdrvcardaddCtrl.html">apdrvcardaddCtrl</a>
              </li><li>
                <a href="carSafety.apdrvcardlogCtrl.html">apdrvcardlogCtrl</a>
              </li><li>
                <a href="carSafety.apmailnotifyaddCtrl.html">apmailnotifyaddCtrl</a>
              </li><li>
                <a href="carSafety.apmailnotifyeditCtrl.html">apmailnotifyeditCtrl</a>
              </li><li>
                <a href="carSafety.apmailnotifylistCtrl.html">apmailnotifylistCtrl</a>
              </li><li>
                <a href="carSafety.autologinCtrl.html">autologinCtrl</a>
              </li><li>
                <a href="carSafety.companyProfileCtrl.html">companyProfileCtrl</a>
              </li><li>
                <a href="carSafety.404Ctrl.html">404Ctrl</a>
              </li><li>
                <a href="carSafety.dashCtrl.html">dashCtrl</a>
              </li><li>
                <a href="carSafety.deviceSetCtrl.html">deviceSetCtrl</a>
              </li><li>
                <a href="carSafety.drivergrpProfileCtrl.html">drivergrpProfileCtrl</a>
              </li><li>
                <a href="carSafety.drivergrpSetCtrl.html">drivergrpSetCtrl</a>
              </li><li>
                <a href="carSafety.driverProfileCtrl.html">driverProfileCtrl</a>
              </li><li>
                <a href="carSafety.driverSetCtrl.html">driverSetCtrl</a>
              </li><li>
                <a href="carSafety.forgetPwdCtrl.html">forgetPwdCtrl</a>
              </li><li>
                <a href="carSafety.helpCtrl.html">helpCtrl</a>
              </li><li>
                <a href="carSafety.liveLocationCtrl.html">liveLocationCtrl</a>
              </li><li>
                <a href="carSafety.liveMonitorCtrl.html">liveMonitorCtrl</a>
              </li><li>
                <a href="carSafety.loginCtrl.html">loginCtrl</a>
              </li><li>
                <a href="carSafety.mailNotifySetCtrl.html">mailNotifySetCtrl</a>
              </li><li>
                <a href="carSafety.orgchartSetCtrl.html">orgchartSetCtrl</a>
              </li><li>
                <a href="carSafety.resetPwdCtrl.html">resetPwdCtrl</a>
              </li><li>
                <a href="carSafety.rosterSetCtrl.html">rosterSetCtrl</a>
              </li><li>
                <a href="carSafety.tripDetailCtrl.html">tripDetailCtrl</a>
              </li><li>
                <a href="carSafety.tripDrvImportCtrl.html">tripDrvImportCtrl</a>
              </li><li>
                <a href="carSafety.tripSetCtrl.html">tripSetCtrl</a>
              </li><li>
                <a href="carSafety.updatePwdCtrl.html">updatePwdCtrl</a>
              </li><li>
                <a href="carSafety.userroleSetCtrl.html">userroleSetCtrl</a>
              </li><li>
                <a href="carSafety.userSetCtrl.html">userSetCtrl</a>
              </li><li>
                <a href="carSafety.vehiclegrpProfileCtrl.html">vehiclegrpProfileCtrl</a>
              </li><li>
                <a href="carSafety.vehiclegrpSetCtrl.html">vehiclegrpSetCtrl</a>
              </li><li>
                <a href="carSafety.vehicleProfileCtrl.html">vehicleProfileCtrl</a>
              </li><li>
                <a href="carSafety.vehicleSetCtrl.html">vehicleSetCtrl</a>
              </li><li>
                <a href="carSafety.warnExportCtrl.html">warnExportCtrl</a>
              </li><li>
                <a href="carSafety.warnvideoDownloadCtrl.html">warnvideoDownloadCtrl</a>
              </li>
            </ul>
          </ul><ul class="group">
            <h2 class="nav-group">
              <a href ng-click="car_afetyService = !car_afetyService">
                Service
              </a>
              <i ng-cloak ng-show="car_afetyService">+</i>
            </h2>
            <ul ng-hide="car_afetyService">
              <li>
                <a href="carSafety.alertBox.html">alertBox</a>
              </li><li>
                <a href="carSafety.formValidService.html">formValidService</a>
              </li><li>
                <a href="carSafety.httpSuccessCheck.html">httpSuccessCheck</a>
              </li><li>
                <a href="carSafety.langService.html">langService</a>
              </li><li>
                <a href="carSafety.profileService.html">profileService</a>
              </li><li>
                <a href="carSafety.refetchMapService.html">refetchMapService</a>
              </li><li>
                <a href="carSafety.responsiveCheck.html">responsiveCheck</a>
              </li>
            </ul>
          </ul><ul class="group">
            <h2 class="nav-group">
              <a href ng-click="car_afetyConfig = !car_afetyConfig">
                Config
              </a>
              <i ng-cloak ng-show="car_afetyConfig">+</i>
            </h2>
            <ul ng-hide="car_afetyConfig">
              <li>
                <a href="carSafety.angular-chart-js.html">angular-chart-js</a>
              </li><li>
                <a href="carSafety.angular-dynamic-locale.html">angular-dynamic-locale</a>
              </li><li>
                <a href="carSafety.angular-translate.html">angular-translate</a>
              </li><li>
                <a href="carSafety.angularjs.html">angularjs</a>
              </li><li>
                <a href="carSafety.angularjs-material.html">angularjs-material</a>
              </li><li>
                <a href="carSafety.block-ui.html">block-ui</a>
              </li><li>
                <a href="carSafety.ng-idle.html">ng-idle</a>
              </li><li>
                <a href="carSafety.state-transition.html">state-transition</a>
              </li><li>
                <a href="carSafety.ui-router.html">ui-router</a>
              </li>
            </ul>
          </ul><ul class="group">
            <h2 class="nav-group">
              <a href ng-click="car_afetyConstant = !car_afetyConstant">
                Constant
              </a>
              <i ng-cloak ng-show="car_afetyConstant">+</i>
            </h2>
            <ul ng-hide="car_afetyConstant">
              <li>
                <a href="carSafety.appConfig.html">appConfig</a>
              </li><li>
                <a href="carSafety.chartConfig.html">chartConfig</a>
              </li><li>
                <a href="carSafety.errorCodeConfig.html">errorCodeConfig</a>
              </li><li>
                <a href="carSafety.exportConfig.html">exportConfig</a>
              </li><li>
                <a href="carSafety.mapConfig.html">mapConfig</a>
              </li><li>
                <a href="carSafety.regexConfig.html">regexConfig</a>
              </li>
            </ul>
          </ul><ul class="group">
            <h2 class="nav-group">
              <a href ng-click="car_afetyDirective = !car_afetyDirective">
                Directive
              </a>
              <i ng-cloak ng-show="car_afetyDirective">+</i>
            </h2>
            <ul ng-hide="car_afetyDirective">
              <li>
                <a href="carSafety.bInfoWindow.html">bInfoWindow</a>
              </li><li>
                <a href="carSafety.bMarker.html">bMarker</a>
              </li><li>
                <a href="carSafety.bPolyline.html">bPolyline</a>
              </li><li>
                <a href="carSafety.bTrafficLayer.html">bTrafficLayer</a>
              </li><li>
                <a href="carSafety.convertToNumber.html">convertToNumber</a>
              </li><li>
                <a href="carSafety.customOnChange.html">customOnChange</a>
              </li><li>
                <a href="carSafety.fileInputImg.html">fileInputImg</a>
              </li><li>
                <a href="carSafety.multicheckListbox.html">multicheckListbox</a>
              </li><li>
                <a href="carSafety.navbar.html">navbar</a>
              </li><li>
                <a href="carSafety.pageSelect.html">pageSelect</a>
              </li><li>
                <a href="carSafety.showTooltipOnTextOverflow.html">showTooltipOnTextOverflow</a>
              </li><li>
                <a href="carSafety.stFiltered.html">stFiltered</a>
              </li><li>
                <a href="carSafety.stPersist.html">stPersist</a>
              </li><li>
                <a href="carSafety.stSelectDistinct.html">stSelectDistinct</a>
              </li><li>
                <a href="carSafety.virtualResize.html">virtualResize</a>
              </li>
            </ul>
          </ul><ul class="group">
            <h2 class="nav-group">
              <a href ng-click="car_afetyFilter = !car_afetyFilter">
                Filter
              </a>
              <i ng-cloak ng-show="car_afetyFilter">+</i>
            </h2>
            <ul ng-hide="car_afetyFilter">
              <li>
                <a href="carSafety.fixNum.html">fixNum</a>
              </li><li>
                <a href="carSafety.optionalFilter.html">optionalFilter</a>
              </li><li>
                <a href="carSafety.tableCustomFilter.html">tableCustomFilter</a>
              </li>
            </ul>
          </ul><ul class="group">
            <h2 class="nav-group">
              <a href ng-click="car_afetyRun = !car_afetyRun">
                Run
              </a>
              <i ng-cloak ng-show="car_afetyRun">+</i>
            </h2>
            <ul ng-hide="car_afetyRun">
              <li>
                <a href="carSafety.state-transition-init.html">state-transition-init</a>
              </li>
            </ul>
          </ul>
        </li>
      </ul>
      </div>
    </nav>
    <div id="content" class="page-wrap">
      <h1 class="title">
        source : apcompanyeditCtrl.js
      </h1>
      <div id="main" class="big-container">
        <!-- source code html -->
        <article>
          <pre class="prettyprint source linenums"><code>/*
* @Author: Zilvia Kam
* @Date:   2019-08-26 11:53:42
* @Last Modified by:   Zilvia Kam
* @Last Modified time: 2019-10-08 11:18:22
*/
/**
 * @memberof carSafety
 * @ngdoc Controller
 * @name apcompanyeditCtrl
 * @requires $scope,$state,$stateParams,$http,blockUI,$timeout,$translate,langService,Keepalive,appConfig,httpSuccessCheck,alertBox,refetchMapService
 * @description
 *   Controller for admin panel - edit company page.
 */
angular.module('carSafety').controller("apcompanyeditCtrl",["$scope","$state","$stateParams","$http","blockUI","$timeout","$translate","langService", "Keepalive", "appConfig", "httpSuccessCheck", "alertBox","refetchMapService", function($scope, $state, $stateParams, $http, blockUI, $timeout, $translate, langService, Keepalive, appConfig, httpSuccessCheck,alertBox,refetchMapService){
    var blockUi = angular.element(document.getElementsByTagName("BODY")[0]);
	$translate.use('en')
	window.document.title = 'Company Management - Admin Panel'
	var token
	if($state.params.token){
		token = $state.params.token
	}
	else if(sessionStorage.getItem('adminpanel_token')){
		token = sessionStorage.getItem('adminpanel_token')
	}
	else{
		$state.go('adminpanellogin', {}, { reload: true })
	}
	$scope.disclaimerType = ['default','en','zhtw','zhcn']
	if($state.params.company){
		$scope.funcs = appConfig.userFunc;
		if($state.params.company.pwd_renewal_day===null){
    		$scope.pwd_renewal_day_enable = 'N'
    	}
    	else{
    		$scope.pwd_renewal_day_enable = 'Y'
    	}
    	angular.forEach($scope.disclaimerType, function(value, key) {
		  	if($state.params.company['banner_'+value]===null){
	    		$scope['disclaimer_'+value] = 'N'
	    	}
	    	else{
	    		$scope['disclaimer_'+value] = 'Y'
	    		$state.params.company['banner_'+value] += " (uploaded)"
	    	}
		});
    	$scope.pwd_renewal_day_display = 'NA'
		$scope.company = $state.params.company
		$scope.editcompany = angular.copy($scope.company)
	}
	else{
		$state.go('apcompanylist', {}, { reload: true })
	}
	$scope.toNav = function(){
        $state.go('adminpanelnav', {}, { reload: true })
    }
    $scope.toList = function(){
        $state.go('apcompanylist', {}, { reload: true })
    }
	$scope.toLogout = function(){
    	sessionStorage.removeItem('adminpanel_token');
    	$state.go('adminpanellogin', {}, { reload: true })
    }
    $scope.pwdRules = []
    for (var i = 1; i&lt;= 4; i++) {
    	$scope.pwdRules.push(i);
    }
    $scope.toggleSelection = function(func) {
	    var idx = $scope.editcompany.func.indexOf(func);
	    if (idx > -1) {
	      	$scope.editcompany.func.splice(idx, 1);
	    }
	    else {
	      	$scope.editcompany.func.push(func);
	    }
	};
    $scope.compareArr = function(_arr1,_arr2){
    	if (!Array.isArray(_arr1) || ! Array.isArray(_arr2) || _arr1.length !== _arr2.length){
	      	return false;
    	}
	    var arr1 = _arr1.concat().sort();
	    var arr2 = _arr2.concat().sort();
	    for (var i = 0; i &lt; arr1.length; i++) {
	        if (arr1[i] !== arr2[i]){
	            return false;
	        }
	    }
	    return true;
    }
    $scope.enablePwdRenew = function(){
    	if($scope.pwd_renewal_day_enable == 'Y'){
    		if($scope.editcompany.pwd_renewal_day===null){
    			$scope.editcompany.pwd_renewal_day = 90
    		}
    	}
    }
    $scope.uploadFile = function (ev) {
        var element = ev.target;
        if (element.files && element.files[0]) {
            var file = element.files[0];
            var checkcsv = new RegExp(/^.+\.html$/)
            if (checkcsv.test(file.name) == false) {
                alertBox.titleAlert('warning', 'notCSV')
            }
            else {
            	var type = element.name.split('_')[1];
            	if(element.name.split('_')[1]){
            		$scope['file_'+type] = file
            	}
            	$scope.$apply();
            }
        }
    }
    $scope.enableDisclaimer = function(){
    	if($scope.editcompany.banner=='Y'){
    		$scope.disclaimer_default='Y'
    	}
    }
    $scope.disclaimerCheck = function(){
    	var check = true;
    	if($scope.editcompany.banner=='Y'){
    		angular.forEach($scope.disclaimerType, function(value, key) {
    			if($scope['disclaimer_'+value]=='Y'){
    				if(!$scope.editcompany['banner_'+value] && !$scope['file_'+value]){
			    		check = false
			    	}
    			}
			});
    	}
    	return check;
    }
    $scope.hasFileUpload = function(){
    	var check = false;
    	if($scope.editcompany.banner=='Y'){
    		angular.forEach($scope.disclaimerType, function(value, key) {
    			if($scope['disclaimer_'+value]=='Y'){
    				if($scope['file_'+value]){
			    		check = true
			    	}
    			}
			});
    	}
    	return check;
    }
	$scope.submit = function(){
		var postData = {}
		postData.setting = {}
		if($scope.editcompany.timezone!==$scope.company.timezone){
			postData.setting.timezone = $scope.editcompany.timezone
		}
		if($scope.editcompany.pwd_lockout_cnt!==$scope.company.pwd_lockout_cnt){
			postData.setting.pwd_lockout_cnt = $scope.editcompany.pwd_lockout_cnt
		}
		if($scope.editcompany.pwd_length!==$scope.company.pwd_length){
			postData.setting.pwd_length = $scope.editcompany.pwd_length
		}
		if($scope.editcompany.pwd_rule!==$scope.company.pwd_rule){
			postData.setting.pwd_rule = $scope.editcompany.pwd_rule
		}
		if($scope.editcompany.pwd_change_limit!==$scope.company.pwd_change_limit){
			if($scope.editcompany.pwd_change_limit=='Yes'){
				postData.setting.pwd_change_limit = 'Y'
			}
			else{
				postData.setting.pwd_change_limit = 'N'
			}
		}
		if($scope.editcompany.pwd_history!==$scope.company.pwd_history){
			postData.setting.pwd_history = $scope.editcompany.pwd_history
		}
		if($scope.pwd_renewal_day_enable == 'Y'){
			if($scope.editcompany.pwd_renewal_day!==$scope.company.pwd_renewal_day){
				postData.setting.pwd_renewal_day = $scope.editcompany.pwd_renewal_day
			}
		}
		else{
			if($scope.company.pwd_renewal_day!==null){
				postData.setting.pwd_renewal_day = 'NULL'
			}
		}
		if($scope.editcompany.status!==$scope.company.status){
			if($scope.editcompany.status=='Active'){
				postData.setting.status = 'A'
			}
			else{
				postData.setting.status = 'I'
			}
		}
		if($scope.editcompany.banner!==$scope.company.banner){
			postData.setting.banner = $scope.editcompany.banner
		}
		if($scope.editcompany.banner=='Y'){
			angular.forEach($scope.disclaimerType, function(value, key) {
    			if($scope['disclaimer_'+value]=='Y'){
    				if($scope['file_'+value]){
			    		postData['file_'+value] = $scope['file_'+value]
			    	}
    			}
			});
		}
		if(Object.getOwnPropertyNames(postData.setting).length==0){
			delete postData.setting;
		}
		if(!$scope.compareArr($scope.editcompany.func,$scope.company.func)){
			postData.func = $scope.editcompany.func
		}
		if(postData.setting || postData.func || $scope.hasFileUpload()){
			postData.company_id = $scope.company.company_id
			var httpRequestSet = {
				method: 'POST',
				url: '/api/adminpanel/company/edit',
				headers: {
	    			'Authorization': token
	            },
	            data: postData
			}
			if($scope.hasFileUpload()){
				httpRequestSet.headers['Content-Type'] = undefined
				httpRequestSet.transformRequest = function (data) {
	                var formData = new FormData();
	                angular.forEach(postData, function(value, key) {
	                	if(!key.includes("file_")){
	                		if(typeof(value) === 'object'){
	                			formData.append(key, JSON.stringify(value));
	                		}
	                		else{
	                			formData.append(key, value);
	                		}
	                	}
	                });
	                angular.forEach($scope.disclaimerType, function(value, key) {
	                	if($scope['disclaimer_'+value]=='Y'){
	                		console.log(postData['file_'+value])
		    				if(postData['file_'+value]){
					    		formData.append('file_'+value, $scope['file_'+value]);
					    	}
					    }
					});
					console.log(formData)
	                return formData;
	            }
			}
			$http(httpRequestSet).then(function successCallback(response) {
				blockUi.removeClass('block-ui-active block-ui-visible')
				var errorphp = httpSuccessCheck.checkHttp(response)
				if(errorphp){
					alertBox.contentAlert('error','internalErr_title','internalErr_text')
				}
				else{
					alertBox.titleAlert('success', 'editSuccess', $scope.toList)
				}
			}, function errorCallback(response) {
				blockUi.removeClass('block-ui-active block-ui-visible')
				var errorphp = httpSuccessCheck.checkerrorHttp(response)
	            if(errorphp){
	              	alertBox.contentAlert('error','internalErr_title','internalErr_text')
	            }
	            else{
					alertBox.notranslationAlert(response.data.message,response.data.detail,'error')
	            }
			})
		}
		else{
			alertBox.titleAlert('success', 'editSuccess', $scope.toList)
		}
	}
}]);</code></pre>
        </article>
        <!-- index.html -->
        <!-- class files -->
      </div>
      <footer style="clear:both">
        Documentation generated by
        <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a>
        using
        <a href="https://github.com/allenhwkim/angular-jsdoc">Angular-JSDoc template</a>
      </footer>
    </div>
    <script src="js/prettify.js"></script>
    <script src="js/angular.min.js"></script>
    <script src="js/site.js"></script>
    <!--%= prettyJson %-->
    <script>
      prettyPrint();
      var lineNo = window.location.hash.match(/#line([0-9]+)$/);
      lineNo && document.querySelector("ol li:nth-child("+(lineNo[1])+")").scrollIntoView();
    </script>
  </body>
</html>